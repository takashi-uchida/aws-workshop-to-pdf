# 設計ドキュメント

## 概要

既存のNode.js/Playwright CLIツールをブラウザベースのWebアプリケーションに変換します。ブラウザの制限により、Playwrightは使用できないため、代替アプローチとして以下の2つの戦略を採用します：

1. **プロキシサービス経由のPDF生成**：外部APIサービス（例：Puppeteer as a Service）を使用
2. **ブラウザネイティブのprint to PDF機能**：`window.print()`とブラウザの印刷機能を活用

本設計では、**戦略2（ブラウザネイティブ機能）**を採用します。これにより、完全にクライアントサイドで動作し、外部サービスへの依存がなく、GitHub Pagesで無料でホスティング可能です。

### 技術的制約

- **CORS制限**：ブラウザから直接他のドメインのコンテンツを取得できない
- **Playwrightの非互換性**：ブラウザ環境ではNode.js専用のPlaywrightは動作しない
- **iframeのサンドボックス**：クロスオリジンのiframeコンテンツには制限がある

### 解決策

ユーザーが入力したURLをiframeで読み込み、ブラウザの印刷機能（`window.print()`）を使用してPDF化します。CORS制限により、同一オリジンのページのみ完全にサポートされますが、多くのブラウザはクロスオリジンiframeの印刷もサポートしています。

## アーキテクチャ

### システム構成

```
┌─────────────────────────────────────────┐
│         GitHub Pages (静的ホスティング)      │
│  ┌───────────────────────────────────┐  │
│  │         index.html                │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │   App Component (app.js)    │  │  │
│  │  │  - UI管理                    │  │  │
│  │  │  - イベントハンドリング         │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │ PDFConverter (converter.js) │  │  │
│  │  │  - iframe管理                │  │  │
│  │  │  - 印刷トリガー               │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │ BatchProcessor (batch.js)   │  │  │
│  │  │  - 複数URL処理               │  │  │
│  │  │  - 進捗管理                  │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │   styles.css                │  │  │
│  │  │  - レスポンシブデザイン        │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 技術スタック

- **HTML5**：セマンティックマークアップ
- **CSS3**：レスポンシブデザイン、Flexbox/Grid
- **Vanilla JavaScript (ES6+)**：フレームワーク不要、軽量
- **Browser Print API**：`window.print()`を使用したPDF生成

### ファイル構成

```
/
├── index.html          # メインHTMLファイル
├── css/
│   └── styles.css      # スタイルシート
├── js/
│   ├── app.js          # アプリケーションメインロジック
│   ├── converter.js    # PDF変換ロジック
│   ├── batch.js        # バッチ処理ロジック
│   └── utils.js        # ユーティリティ関数
└── README.md           # GitHub Pages用ドキュメント
```

## コンポーネントとインターフェース

### 1. App Component (`app.js`)

アプリケーションのメインコントローラー。

**責務：**
- UI初期化
- ユーザー入力の検証
- モード切り替え（シングル/バッチ）
- 設定管理

**主要メソッド：**

```javascript
class App {
  constructor() {
    this.converter = new PDFConverter();
    this.batchProcessor = new BatchProcessor(this.converter);
    this.settings = this.loadSettings();
  }

  init() {
    // イベントリスナーの設定
    // UI初期化
  }

  handleSingleConversion(url) {
    // 単一URL変換の処理
  }

  handleBatchConversion(urls) {
    // バッチ変換の処理
  }

  loadSettings() {
    // localStorage から設定を読み込み
  }

  saveSettings(settings) {
    // localStorage に設定を保存
  }
}
```

### 2. PDFConverter Component (`converter.js`)

PDF変換の核となるロジック。

**責務：**
- iframeでURLを読み込み
- 印刷ダイアログのトリガー
- エラーハンドリング

**主要メソッド：**

```javascript
class PDFConverter {
  constructor() {
    this.iframe = null;
    this.currentSettings = {};
  }

  async convertToPDF(url, settings) {
    // 1. 非表示iframeを作成
    // 2. URLを読み込み
    // 3. 読み込み完了を待機
    // 4. 印刷ダイアログを開く
    // 5. クリーンアップ
  }

  createIframe(url) {
    // iframe要素を作成して返す
  }

  waitForLoad(iframe, timeout = 30000) {
    // iframeの読み込み完了を待つ
  }

  triggerPrint(iframe) {
    // iframeのwindow.print()を呼び出す
  }

  cleanup() {
    // iframeを削除
  }
}
```

### 3. BatchProcessor Component (`batch.js`)

複数URLの処理を管理。

**責務：**
- URL配列の処理
- 進捗状況の追跡
- エラーレポート

**主要メソッド：**

```javascript
class BatchProcessor {
  constructor(converter) {
    this.converter = converter;
    this.queue = [];
    this.results = [];
  }

  async processBatch(urls, settings, onProgress) {
    // 各URLを順次処理
    // 進捗コールバックを呼び出し
    // 結果を収集
  }

  async processURL(url, settings) {
    // 単一URLを処理
    // 成功/失敗を記録
  }

  getResults() {
    // 処理結果のサマリーを返す
  }
}
```

### 4. Utils Module (`utils.js`)

共通ユーティリティ関数。

**主要関数：**

```javascript
// URL検証
function isValidURL(url) {
  // URLの妥当性をチェック
}

// URLリストのパース
function parseURLList(text) {
  // テキストからURL配列を抽出
  // コメント行と空行を除外
}

// エラーメッセージの生成
function getErrorMessage(error) {
  // エラータイプに応じた日本語メッセージを返す
}

// 設定のバリデーション
function validateSettings(settings) {
  // 設定値の妥当性をチェック
}
```

## データモデル

### Settings

```javascript
{
  pageSize: 'A4',           // 'A4' | 'Letter' | 'Legal'
  orientation: 'portrait',  // 'portrait' | 'landscape'
  margins: {
    top: '1cm',
    right: '1cm',
    bottom: '1cm',
    left: '1cm'
  },
  scale: 1.0,              // 0.1 - 2.0
  printBackground: true     // 背景色と画像を印刷
}
```

### ConversionResult

```javascript
{
  url: 'https://example.com',
  status: 'success',        // 'success' | 'failed' | 'pending' | 'processing'
  timestamp: 1234567890,
  error: null               // エラーがある場合のメッセージ
}
```

### BatchResult

```javascript
{
  total: 10,
  successful: 8,
  failed: 2,
  results: [ConversionResult, ...]
}
```

## エラーハンドリング

### エラータイプと対応

1. **無効なURL**
   - 検証：URL形式のチェック
   - メッセージ：「無効なURLです。正しい形式で入力してください。」

2. **読み込みタイムアウト**
   - タイムアウト：30秒
   - メッセージ：「ページの読み込みがタイムアウトしました。URLを確認してください。」

3. **CORS制限**
   - 検出：iframe読み込みエラー
   - メッセージ：「このページはCORS制限によりアクセスできません。同一オリジンのページをお試しください。」
   - ヒント：「💡 ヒント：ブラウザ拡張機能やプロキシサービスの使用を検討してください。」

4. **ネットワークエラー**
   - 検出：fetch/load失敗
   - メッセージ：「ネットワークエラーが発生しました。接続を確認してください。」

5. **ブラウザ非対応**
   - 検出：機能検出
   - メッセージ：「お使いのブラウザはこの機能をサポートしていません。Chrome、Firefox、Edgeの最新版をお使いください。」

### エラー表示

- トースト通知：一時的なエラー
- インラインメッセージ：フォーム検証エラー
- モーダル：重大なエラー

## テスト戦略

### 手動テスト

1. **機能テスト**
   - 単一URL変換
   - バッチURL変換
   - 設定の保存と読み込み
   - エラーハンドリング

2. **ブラウザ互換性テスト**
   - Chrome（最新版）
   - Firefox（最新版）
   - Safari（最新版）
   - Edge（最新版）

3. **レスポンシブテスト**
   - モバイル（320px - 480px）
   - タブレット（481px - 768px）
   - デスクトップ（769px以上）

4. **CORS制限テスト**
   - 同一オリジンページ
   - クロスオリジンページ
   - HTTPS vs HTTP

### テストシナリオ

**シナリオ1：単一URL変換**
1. 有効なURLを入力
2. 変換ボタンをクリック
3. 印刷ダイアログが表示されることを確認
4. PDFとして保存できることを確認

**シナリオ2：バッチ変換**
1. 複数のURL（5個）を入力
2. バッチ変換を開始
3. 進捗表示が更新されることを確認
4. すべてのURLが処理されることを確認
5. 結果サマリーが表示されることを確認

**シナリオ3：エラーハンドリング**
1. 無効なURLを入力
2. エラーメッセージが表示されることを確認
3. アクセス不可のURLを入力
4. 適切なエラーメッセージが表示されることを確認

**シナリオ4：設定の永続化**
1. PDF設定を変更
2. ページをリロード
3. 設定が保持されていることを確認

## UI/UXデザイン

### レイアウト構成

```
┌─────────────────────────────────────┐
│           ヘッダー                    │
│  Web to PDF Converter               │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         モード選択タブ                │
│  [単一URL] [バッチ変換]              │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         入力エリア                    │
│  ┌───────────────────────────────┐  │
│  │ URL入力フィールド              │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 設定パネル（折りたたみ可能）    │  │
│  │ - ページサイズ                 │  │
│  │ - 向き                        │  │
│  │ - 余白                        │  │
│  └───────────────────────────────┘  │
│                                     │
│         [変換開始]                   │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         進捗/結果エリア               │
│  ステータス表示                      │
│  エラーメッセージ                    │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         フッター                     │
│  使用方法 | 制限事項 | GitHub       │
└─────────────────────────────────────┘
```

### カラースキーム

- プライマリ：#2563eb（青）
- セカンダリ：#64748b（グレー）
- 成功：#10b981（緑）
- エラー：#ef4444（赤）
- 警告：#f59e0b（オレンジ）
- 背景：#f8fafc（ライトグレー）
- テキスト：#1e293b（ダークグレー）

### レスポンシブブレークポイント

- モバイル：< 640px
- タブレット：640px - 1024px
- デスクトップ：> 1024px

## GitHub Pagesデプロイ

### デプロイ手順

1. **リポジトリ設定**
   - Settings > Pages
   - Source: Deploy from a branch
   - Branch: main / root

2. **ファイル配置**
   - すべてのファイルをルートディレクトリに配置
   - または`docs/`ディレクトリを使用

3. **カスタムドメイン（オプション）**
   - CNAMEファイルを追加
   - DNS設定を更新

### 最適化

- **ファイルサイズ削減**：CSS/JSの最小化
- **キャッシング**：適切なCache-Controlヘッダー
- **SEO**：メタタグの最適化

## 制限事項と今後の拡張

### 現在の制限

1. **CORS制限**：クロスオリジンページへのアクセスが制限される
2. **印刷ダイアログ**：ユーザーが手動でPDFとして保存する必要がある
3. **自動ダウンロード不可**：ブラウザのセキュリティ制限により完全自動化は不可
4. **ページ内容の制御不可**：JavaScriptで動的に生成されるコンテンツの完全な制御は困難

### 今後の拡張案

1. **プロキシサービス統合**：CORS制限を回避するためのオプション
2. **ブラウザ拡張機能**：より高度な制御のための拡張機能版
3. **プリセット管理**：よく使う設定の保存
4. **履歴機能**：過去の変換履歴の表示
5. **ブックマークレット**：任意のページから直接変換を開始

## セキュリティ考慮事項

1. **XSS対策**：ユーザー入力のサニタイズ
2. **CSP設定**：Content Security Policyの適用
3. **HTTPS強制**：GitHub Pagesは自動的にHTTPSを使用
4. **入力検証**：すべてのユーザー入力を検証

## パフォーマンス考慮事項

1. **遅延読み込み**：必要に応じてコンポーネントを読み込み
2. **デバウンス**：入力イベントのデバウンス処理
3. **メモリ管理**：使用後のiframe削除
4. **タイムアウト設定**：長時間の読み込みを防ぐ
